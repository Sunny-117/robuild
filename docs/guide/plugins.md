# æ’ä»¶ç³»ç»Ÿ

robuild åŸºäº rolldown çš„æ’ä»¶ç³»ç»Ÿï¼Œæä¾›äº†å¼ºå¤§çš„æ‰©å±•èƒ½åŠ›ã€‚rolldown åŸç”Ÿæ”¯æŒ JSONã€CommonJSã€æ¨¡å—è§£æå’Œ React/JSX è½¬æ¢ï¼Œæ— éœ€é¢å¤–æ’ä»¶ã€‚

## ğŸ”Œ æ’ä»¶å…¼å®¹æ€§

### Rolldown åŸç”Ÿæ”¯æŒ

rolldown å†…ç½®äº†è®¸å¤šå¸¸ç”¨åŠŸèƒ½ï¼Œæ— éœ€é¢å¤–æ’ä»¶ï¼š

```typescript
import { defineConfig } from 'robuild'

export default defineConfig({
  entries: [
    {
      type: 'bundle',
      input: './src/index.ts',
      // ä»¥ä¸‹åŠŸèƒ½åŸç”Ÿæ”¯æŒï¼Œæ— éœ€æ’ä»¶ï¼š
      // - JSON æ–‡ä»¶å¯¼å…¥
      // - CommonJS æ¨¡å—
      // - Node.js æ¨¡å—è§£æ
      // - React/JSX è½¬æ¢
      // - TypeScript ç¼–è¯‘
    }
  ]
})
```

### Rollup æ’ä»¶æ”¯æŒ

robuild å…¼å®¹å¤§éƒ¨åˆ† Rollup æ’ä»¶ï¼š

```typescript
import { defineConfig } from 'robuild'
import { visualizer } from 'rollup-plugin-visualizer'
import { terser } from 'rollup-plugin-terser'

export default defineConfig({
  entries: [
    {
      type: 'bundle',
      input: './src/index.ts',
      plugins: [
        // æ‰“åŒ…åˆ†ææ’ä»¶
        visualizer({
          filename: 'dist/stats.html',
          open: true
        }),
        // ä»£ç å‹ç¼©æ’ä»¶
        terser({
          compress: {
            drop_console: true
          }
        })
      ]
    }
  ]
})
```

### Unplugin æ”¯æŒ

Universal æ’ä»¶æ”¯æŒï¼Œè·¨å¹³å°å…¼å®¹ï¼š

```typescript
import { defineConfig } from 'robuild'
import { unpluginAutoImport } from 'unplugin-auto-import/rollup'
import { unpluginIcons } from 'unplugin-icons/rollup'

export default defineConfig({
  entries: [
    {
      type: 'bundle',
      input: './src/index.ts',
      plugins: [
        // è‡ªåŠ¨å¯¼å…¥æ’ä»¶
        unpluginAutoImport({
          imports: ['vue', 'vue-router'],
          dts: true
        }),
        // å›¾æ ‡æ’ä»¶
        unpluginIcons({
          compiler: 'vue3'
        })
      ]
    }
  ]
})
```

## åŸç”ŸåŠŸèƒ½

### 1. JSON æ–‡ä»¶æ”¯æŒ

rolldown åŸç”Ÿæ”¯æŒ JSON æ–‡ä»¶å¯¼å…¥ï¼Œæ— éœ€é¢å¤–æ’ä»¶ï¼š

```typescript
// src/config.json
{
  "name": "my-app",
  "version": "1.0.0",
  "features": ["auth", "dashboard"]
}

// src/index.ts
import config from './config.json'

console.log(config.name) // "my-app"
console.log(config.features) // ["auth", "dashboard"]
```

### 2. React/JSX æ”¯æŒ

rolldown åŸç”Ÿæ”¯æŒ React å’Œ JSX è½¬æ¢ï¼š

```typescript
// src/App.tsx
import React from 'react'

export function App() {
  return <div>Hello React!</div>
}

// build.config.ts
export default defineConfig({
  entries: [
    {
      type: 'bundle',
      input: './src/App.tsx',
      // JSX è‡ªåŠ¨è½¬æ¢ï¼Œæ— éœ€é…ç½®
    }
  ]
})
```

### 3. CommonJS æ”¯æŒ

rolldown åŸç”Ÿæ”¯æŒ CommonJS æ¨¡å—ï¼š

```typescript
// å¯ä»¥ç›´æ¥å¯¼å…¥ CommonJS æ¨¡å—
import lodash from 'lodash'
import express from 'express'

// æ— éœ€ @rollup/plugin-commonjs
```

## åˆ›å»ºè‡ªå®šä¹‰æ’ä»¶

### 1. åŸºæœ¬æ’ä»¶ç»“æ„

```typescript
// my-plugin.ts
interface MyPluginOptions {
  prefix?: string
  suffix?: string
}

export function myPlugin(options: MyPluginOptions = {}) {
  const { prefix = '', suffix = '' } = options

  return {
    name: 'my-plugin',
    setup(build) {
      // æ’ä»¶åˆå§‹åŒ–é€»è¾‘
      console.log('My plugin initialized')
    },
    transform(code, id) {
      // ä»£ç è½¬æ¢é€»è¾‘
      if (id.endsWith('.ts') || id.endsWith('.js')) {
        return `${prefix}${code}${suffix}`
      }
      return code
    }
  }
}
```

### 2. ä½¿ç”¨è‡ªå®šä¹‰æ’ä»¶

```typescript
import { defineConfig } from 'robuild'
import { myPlugin } from './my-plugin'

export default defineConfig({
  entries: [
    {
      type: 'bundle',
      input: './src/index.ts',
      rolldown: {
        plugins: [
          myPlugin({
            prefix: '// Generated by my-plugin\n',
            suffix: '\n// End of generated code'
          })
        ]
      }
    }
  ]
})
```

## æ’ä»¶ç”Ÿå‘½å‘¨æœŸ

### 1. æ’ä»¶åˆå§‹åŒ–

```typescript
{
  name: 'my-plugin',
  setup(build) {
    // åœ¨æ„å»ºå¼€å§‹æ—¶è°ƒç”¨ä¸€æ¬¡
    console.log('æ’ä»¶åˆå§‹åŒ–')

    // å¯ä»¥è®¿é—®æ„å»ºä¸Šä¸‹æ–‡
    console.log('æ„å»ºé…ç½®:', build.config)
  }
}
```

### 2. ä»£ç è½¬æ¢

```typescript
{
  name: 'my-plugin',
  transform(code, id) {
    // å¯¹æ¯ä¸ªæ–‡ä»¶è°ƒç”¨
    if (id.endsWith('.ts')) {
      // è½¬æ¢ TypeScript æ–‡ä»¶
      return code.replace(/console\.log/g, '// console.log')
    }
    return code
  }
}
```

### 3. æ„å»ºé’©å­

```typescript
{
  name: 'my-plugin',
  setup(build) {
    build.onStart(() => {
      console.log('æ„å»ºå¼€å§‹')
    })

    build.onEnd((result) => {
      console.log('æ„å»ºç»“æŸ', result)
    })
  }
}
```

## å®é™…æ’ä»¶ç¤ºä¾‹

### 1. ç‰ˆæœ¬æ³¨å…¥æ’ä»¶

```typescript
// version-inject-plugin.ts
import { readFileSync } from 'fs'

interface VersionInjectOptions {
  packagePath?: string
  placeholder?: string
}

export function versionInjectPlugin(options: VersionInjectOptions = {}) {
  const { packagePath = './package.json', placeholder = '__VERSION__' } = options

  return {
    name: 'version-inject',
    transform(code: string, id: string) {
      if (code.includes(placeholder)) {
        try {
          const pkg = JSON.parse(readFileSync(packagePath, 'utf-8'))
          return code.replace(
            new RegExp(placeholder, 'g'),
            JSON.stringify(pkg.version)
          )
        } catch (error) {
          console.warn('Failed to read package.json:', error)
        }
      }
      return code
    }
  }
}
```

### 2. æ–‡ä»¶å¤´æ³¨é‡Šæ’ä»¶

```typescript
// banner-plugin.ts
interface BannerOptions {
  banner?: string
  include?: RegExp
  exclude?: RegExp
}

export function bannerPlugin(options: BannerOptions = {}) {
  const {
    banner = '/* Generated by robuild */',
    include = /\.(js|mjs|ts)$/,
    exclude
  } = options

  return {
    name: 'banner',
    generateBundle(options: any, bundle: any) {
      Object.keys(bundle).forEach(fileName => {
        const chunk = bundle[fileName]

        if (chunk.type === 'chunk') {
          const shouldInclude = include.test(fileName)
          const shouldExclude = exclude && exclude.test(fileName)

          if (shouldInclude && !shouldExclude) {
            chunk.code = `${banner}\n${chunk.code}`
          }
        }
      })
    }
  }
}
```

### 3. æ¡ä»¶ç¼–è¯‘æ’ä»¶

```typescript
// conditional-compile-plugin.ts
interface ConditionalCompileOptions {
  conditions: Record<string, boolean>
}

export function conditionalCompilePlugin(options: ConditionalCompileOptions) {
  const { conditions } = options

  return {
    name: 'conditional-compile',
    transform(code: string, id: string) {
      let result = code

      // å¤„ç† #ifdef æ¡ä»¶ç¼–è¯‘
      Object.entries(conditions).forEach(([condition, enabled]) => {
        const ifdefRegex = new RegExp(
          `\\/\\*\\s*#ifdef\\s+${condition}\\s*\\*\\/([\\s\\S]*?)\\/\\*\\s*#endif\\s*\\*\\/`,
          'g'
        )

        result = result.replace(ifdefRegex, (match, content) => {
          return enabled ? content.trim() : ''
        })
      })

      return result
    }
  }
}
```

## æ’ä»¶é…ç½®æœ€ä½³å®è·µ

### 1. ç±»å‹å®‰å…¨

```typescript
// å®šä¹‰æ’ä»¶é€‰é¡¹ç±»å‹
interface MyPluginOptions {
  enabled?: boolean
  config?: Record<string, any>
}

// ä½¿ç”¨ç±»å‹å®‰å…¨çš„æ’ä»¶
export function myPlugin(options: MyPluginOptions = {}) {
  const { enabled = true, config = {} } = options

  if (!enabled) {
    return { name: 'my-plugin' } // ç©ºæ’ä»¶
  }

  return {
    name: 'my-plugin',
    setup(build) {
      // ä½¿ç”¨é…ç½®
      console.log('é…ç½®:', config)
    }
  }
}
```

### 2. é”™è¯¯å¤„ç†

```typescript
export function safePlugin() {
  return {
    name: 'safe-plugin',
    transform(code, id) {
      try {
        // æ’ä»¶é€»è¾‘
        return modifiedCode
      } catch (error) {
        console.error(`æ’ä»¶é”™è¯¯ (${id}):`, error)
        return code // è¿”å›åŸå§‹ä»£ç 
      }
    }
  }
}
```

### 3. æ€§èƒ½ä¼˜åŒ–

```typescript
export function optimizedPlugin() {
  const cache = new Map()

  return {
    name: 'optimized-plugin',
    transform(code, id) {
      // ä½¿ç”¨ç¼“å­˜é¿å…é‡å¤å¤„ç†
      if (cache.has(id)) {
        return cache.get(id)
      }

      const result = processCode(code)
      cache.set(id, result)
      return result
    }
  }
}
```

## æ’ä»¶ç”Ÿæ€ç³»ç»Ÿ

### 1. å®˜æ–¹æ’ä»¶

robuild æä¾›äº†ä¸€äº›å®˜æ–¹æ’ä»¶ï¼š

```typescript
import {
  shebangPlugin,
  jsonPlugin,
  // æ›´å¤šå®˜æ–¹æ’ä»¶...
} from 'robuild/plugins'
```

### 2. ç¤¾åŒºæ’ä»¶

æ¨èçš„ç¤¾åŒºæ’ä»¶ï¼š

```typescript
import { defineConfig } from 'robuild'
import { visualizer } from 'rollup-plugin-visualizer'
import { analyzer } from 'rollup-plugin-analyzer'
import { copy } from 'rollup-plugin-copy'

export default defineConfig({
  entries: [
    {
      type: 'bundle',
      input: './src/index.ts',
      plugins: [
        // æ‰“åŒ…åˆ†æ
        visualizer({ filename: 'dist/stats.html' }),
        analyzer({ summaryOnly: true }),
        // æ–‡ä»¶å¤åˆ¶
        copy({
          targets: [
            { src: 'assets/*', dest: 'dist/assets' }
          ]
        })
      ]
    }
  ]
})
```

### 3. æ’ä»¶å¼€å‘

å¼€å‘è‡ªå·±çš„æ’ä»¶ï¼š

```bash
# åˆ›å»ºæ’ä»¶é¡¹ç›®
mkdir robuild-plugin-example
cd robuild-plugin-example
npm init -y

# å®‰è£…å¼€å‘ä¾èµ–
npm install --save-dev typescript @types/node
```

## æ’ä»¶è°ƒè¯•

### 1. è°ƒè¯•æ¨¡å¼

```typescript
export default defineConfig({
  entries: ['./src/index.ts'],
  rolldown: {
    plugins: [
      {
        name: 'debug-plugin',
        setup(build) {
          // å¯ç”¨è°ƒè¯•æ—¥å¿—
          if (process.env.DEBUG) {
            console.log('æ’ä»¶è°ƒè¯•ä¿¡æ¯:', build.config)
          }
        }
      }
    ]
  }
})
```

### 2. æ’ä»¶æµ‹è¯•

```typescript
// æµ‹è¯•æ’ä»¶
import { myPlugin } from './my-plugin'

const plugin = myPlugin({ prefix: '// TEST' })
const result = plugin.transform('console.log("hello")', 'test.js')
console.log(result) // // TEST\nconsole.log("hello")
```

## ä¸‹ä¸€æ­¥

- [Hooks](./hooks.md) - æ„å»ºç”Ÿå‘½å‘¨æœŸé’©å­
- [æ€§èƒ½ä¼˜åŒ–](./performance.md) - ä¼˜åŒ–æ„å»ºæ€§èƒ½
- [é…ç½®](./configuration.md) - è¯¦ç»†é…ç½®é€‰é¡¹
- [API æ–‡æ¡£](../api/) - ç¨‹åºåŒ– API ä½¿ç”¨
