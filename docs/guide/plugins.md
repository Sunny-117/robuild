# æ’ä»¶ç³»ç»Ÿ

robuild æä¾›äº†å¼ºå¤§çš„æ’ä»¶ç³»ç»Ÿï¼Œæ”¯æŒ Rollupã€Viteã€Unplugin ç­‰å¤šç§æ’ä»¶æ ¼å¼ï¼Œè®©ä½ èƒ½å¤Ÿè½»æ¾æ‰©å±•æ„å»ºåŠŸèƒ½ã€‚

## ğŸ”Œ æ’ä»¶å…¼å®¹æ€§

### Rollup æ’ä»¶æ”¯æŒ

robuild å®Œå…¨å…¼å®¹ Rollup æ’ä»¶ç”Ÿæ€ç³»ç»Ÿï¼š

```typescript
import { defineConfig } from 'robuild'
import json from '@rollup/plugin-json'
import resolve from '@rollup/plugin-node-resolve'
import commonjs from '@rollup/plugin-commonjs'

export default defineConfig({
  entries: [
    {
      type: 'bundle',
      input: './src/index.ts',
      plugins: [
        resolve(),
        commonjs(),
        json()
      ]
    }
  ]
})
```

### Vite æ’ä»¶æ”¯æŒ

éƒ¨åˆ†æ”¯æŒ Vite æ’ä»¶ï¼ˆè‡ªåŠ¨é€‚é…ï¼‰ï¼š

```typescript
import { defineConfig } from 'robuild'
import react from '@vitejs/plugin-react'

export default defineConfig({
  entries: [
    {
      type: 'bundle',
      input: './src/index.tsx',
      plugins: [
        react() // è‡ªåŠ¨é€‚é… Vite æ’ä»¶
      ]
    }
  ]
})
```

### Unplugin æ”¯æŒ

Universal æ’ä»¶æ”¯æŒï¼Œè·¨å¹³å°å…¼å®¹ï¼š

```typescript
import { defineConfig } from 'robuild'
import { unpluginExample } from 'unplugin-example'

export default defineConfig({
  entries: [
    {
      type: 'bundle',
      input: './src/index.ts',
      plugins: [
        unpluginExample() // è‡ªåŠ¨é€‚é… Unplugin
      ]
    }
  ]
})
    {
      type: 'transform',
      input: './src/runtime',
      oxc: {
        plugins: [
          // oxc æ’ä»¶é…ç½®
          {
            name: 'transform-plugin',
            transform(code, id) {
              // è½¬æ¢é€»è¾‘
              return code
            }
          }
        ]
      }
    }
  ]
})
```

## å†…ç½®æ’ä»¶

### 1. Shebang æ’ä»¶

è‡ªåŠ¨å¤„ç† shebang è¡Œï¼š

```typescript
import { shebangPlugin } from 'robuild/plugins'

export default defineConfig({
  entries: [
    {
      type: 'bundle',
      input: './src/cli.ts',
      rolldown: {
        plugins: [shebangPlugin()]
      }
    }
  ]
})
```

**åŠŸèƒ½ï¼š**
- è‡ªåŠ¨æ·»åŠ  shebang è¡Œåˆ° CLI æ–‡ä»¶
- æ”¯æŒè‡ªå®šä¹‰ shebang å†…å®¹
- ä¿æŒå¯æ‰§è¡Œæƒé™

**é…ç½®é€‰é¡¹ï¼š**
```typescript
shebangPlugin({
  shebang: '#!/usr/bin/env node',
  preserve: true
})
```

### 2. JSON æ”¯æŒ

JSON æ–‡ä»¶å¯¼å…¥ç”± rolldown åŸç”Ÿæ”¯æŒï¼Œæ— éœ€é¢å¤–æ’ä»¶ï¼š

```typescript
// ç›´æ¥å¯¼å…¥ JSON æ–‡ä»¶
import config from './config.json'

export default defineConfig({
  entries: [
    {
      type: 'bundle',
      input: './src/index.ts',
      // JSON å¯¼å…¥è‡ªåŠ¨æ”¯æŒï¼Œæ— éœ€é…ç½®
    }
  ]
})
```

**åŠŸèƒ½ï¼š**
- åŸç”Ÿæ”¯æŒ JSON æ–‡ä»¶å¯¼å…¥
- è‡ªåŠ¨ç±»å‹æ¨æ–­
- é›¶é…ç½®ä½¿ç”¨

## åˆ›å»ºè‡ªå®šä¹‰æ’ä»¶

### 1. åŸºæœ¬æ’ä»¶ç»“æ„

```typescript
// my-plugin.ts
interface MyPluginOptions {
  prefix?: string
  suffix?: string
}

export function myPlugin(options: MyPluginOptions = {}) {
  const { prefix = '', suffix = '' } = options

  return {
    name: 'my-plugin',
    setup(build) {
      // æ’ä»¶åˆå§‹åŒ–é€»è¾‘
      console.log('My plugin initialized')
    },
    transform(code, id) {
      // ä»£ç è½¬æ¢é€»è¾‘
      if (id.endsWith('.ts') || id.endsWith('.js')) {
        return `${prefix}${code}${suffix}`
      }
      return code
    }
  }
}
```

### 2. ä½¿ç”¨è‡ªå®šä¹‰æ’ä»¶

```typescript
import { defineConfig } from 'robuild'
import { myPlugin } from './my-plugin'

export default defineConfig({
  entries: [
    {
      type: 'bundle',
      input: './src/index.ts',
      rolldown: {
        plugins: [
          myPlugin({
            prefix: '// Generated by my-plugin\n',
            suffix: '\n// End of generated code'
          })
        ]
      }
    }
  ]
})
```

## æ’ä»¶ç”Ÿå‘½å‘¨æœŸ

### 1. æ’ä»¶åˆå§‹åŒ–

```typescript
{
  name: 'my-plugin',
  setup(build) {
    // åœ¨æ„å»ºå¼€å§‹æ—¶è°ƒç”¨ä¸€æ¬¡
    console.log('æ’ä»¶åˆå§‹åŒ–')

    // å¯ä»¥è®¿é—®æ„å»ºä¸Šä¸‹æ–‡
    console.log('æ„å»ºé…ç½®:', build.config)
  }
}
```

### 2. ä»£ç è½¬æ¢

```typescript
{
  name: 'my-plugin',
  transform(code, id) {
    // å¯¹æ¯ä¸ªæ–‡ä»¶è°ƒç”¨
    if (id.endsWith('.ts')) {
      // è½¬æ¢ TypeScript æ–‡ä»¶
      return code.replace(/console\.log/g, '// console.log')
    }
    return code
  }
}
```

### 3. æ„å»ºé’©å­

```typescript
{
  name: 'my-plugin',
  setup(build) {
    build.onStart(() => {
      console.log('æ„å»ºå¼€å§‹')
    })

    build.onEnd((result) => {
      console.log('æ„å»ºç»“æŸ', result)
    })
  }
}
```

## å®é™…æ’ä»¶ç¤ºä¾‹

### 1. ç¯å¢ƒå˜é‡æ›¿æ¢æ’ä»¶

```typescript
// env-replace-plugin.ts
interface EnvReplaceOptions {
  env?: Record<string, string>
  prefix?: string
}

export function envReplacePlugin(options: EnvReplaceOptions = {}) {
  const { env = process.env, prefix = 'process.env.' } = options

  return {
    name: 'env-replace',
    transform(code, id) {
      // æ›¿æ¢ process.env.VARIABLE ä¸ºå®é™…å€¼
      return code.replace(
        new RegExp(`${prefix}(\\w+)`, 'g'),
        (match, key) => {
          const value = env[key]
          return value ? JSON.stringify(value) : 'undefined'
        }
      )
    }
  }
}
```

### 2. æ–‡ä»¶å¤§å°åˆ†ææ’ä»¶

```typescript
// size-analyzer-plugin.ts
import { readFileSync } from 'fs'
import { join } from 'path'

export function sizeAnalyzerPlugin() {
  return {
    name: 'size-analyzer',
    setup(build) {
      build.onEnd((result) => {
        console.log('\næ–‡ä»¶å¤§å°åˆ†æ:')

        result.outputFiles?.forEach(file => {
          const stats = readFileSync(file).length
          const sizeKB = (stats / 1024).toFixed(2)
          console.log(`  ${file}: ${sizeKB} KB`)
        })
      })
    }
  }
}
```

### 3. è‡ªåŠ¨å¯¼å…¥æ’ä»¶

```typescript
// auto-import-plugin.ts
interface AutoImportOptions {
  imports: Record<string, string[]>
}

export function autoImportPlugin(options: AutoImportOptions) {
  const { imports } = options

  return {
    name: 'auto-import',
    transform(code, id) {
      if (!id.endsWith('.ts') && !id.endsWith('.js')) {
        return code
      }

      let importStatements = ''

      // æ£€æŸ¥ä»£ç ä¸­ä½¿ç”¨çš„å¯¼å…¥
      Object.entries(imports).forEach(([module, exports]) => {
        const used = exports.filter(exp =>
          new RegExp(`\\b${exp}\\b`).test(code)
        )

        if (used.length > 0) {
          importStatements += `import { ${used.join(', ')} } from '${module}'\n`
        }
      })

      return importStatements + code
    }
  }
}
```

## æ’ä»¶é…ç½®æœ€ä½³å®è·µ

### 1. ç±»å‹å®‰å…¨

```typescript
// å®šä¹‰æ’ä»¶é€‰é¡¹ç±»å‹
interface MyPluginOptions {
  enabled?: boolean
  config?: Record<string, any>
}

// ä½¿ç”¨ç±»å‹å®‰å…¨çš„æ’ä»¶
export function myPlugin(options: MyPluginOptions = {}) {
  const { enabled = true, config = {} } = options

  if (!enabled) {
    return { name: 'my-plugin' } // ç©ºæ’ä»¶
  }

  return {
    name: 'my-plugin',
    setup(build) {
      // ä½¿ç”¨é…ç½®
      console.log('é…ç½®:', config)
    }
  }
}
```

### 2. é”™è¯¯å¤„ç†

```typescript
export function safePlugin() {
  return {
    name: 'safe-plugin',
    transform(code, id) {
      try {
        // æ’ä»¶é€»è¾‘
        return modifiedCode
      } catch (error) {
        console.error(`æ’ä»¶é”™è¯¯ (${id}):`, error)
        return code // è¿”å›åŸå§‹ä»£ç 
      }
    }
  }
}
```

### 3. æ€§èƒ½ä¼˜åŒ–

```typescript
export function optimizedPlugin() {
  const cache = new Map()

  return {
    name: 'optimized-plugin',
    transform(code, id) {
      // ä½¿ç”¨ç¼“å­˜é¿å…é‡å¤å¤„ç†
      if (cache.has(id)) {
        return cache.get(id)
      }

      const result = processCode(code)
      cache.set(id, result)
      return result
    }
  }
}
```

## æ’ä»¶ç”Ÿæ€ç³»ç»Ÿ

### 1. å®˜æ–¹æ’ä»¶

robuild æä¾›äº†ä¸€äº›å®˜æ–¹æ’ä»¶ï¼š

```typescript
import {
  shebangPlugin,
  jsonPlugin,
  // æ›´å¤šå®˜æ–¹æ’ä»¶...
} from 'robuild/plugins'
```

### 2. ç¤¾åŒºæ’ä»¶

ç¤¾åŒºç»´æŠ¤çš„æ’ä»¶ï¼š

```typescript
import {
  vuePlugin,
  reactPlugin,
  // æ›´å¤šç¤¾åŒºæ’ä»¶...
} from '@robuild/plugins'
```

### 3. æ’ä»¶å¼€å‘

å¼€å‘è‡ªå·±çš„æ’ä»¶ï¼š

```bash
# åˆ›å»ºæ’ä»¶é¡¹ç›®
mkdir robuild-plugin-example
cd robuild-plugin-example
npm init -y

# å®‰è£…å¼€å‘ä¾èµ–
npm install --save-dev typescript @types/node
```

## æ’ä»¶è°ƒè¯•

### 1. è°ƒè¯•æ¨¡å¼

```typescript
export default defineConfig({
  entries: ['./src/index.ts'],
  rolldown: {
    plugins: [
      {
        name: 'debug-plugin',
        setup(build) {
          // å¯ç”¨è°ƒè¯•æ—¥å¿—
          if (process.env.DEBUG) {
            console.log('æ’ä»¶è°ƒè¯•ä¿¡æ¯:', build.config)
          }
        }
      }
    ]
  }
})
```

### 2. æ’ä»¶æµ‹è¯•

```typescript
// æµ‹è¯•æ’ä»¶
import { myPlugin } from './my-plugin'

const plugin = myPlugin({ prefix: '// TEST' })
const result = plugin.transform('console.log("hello")', 'test.js')
console.log(result) // // TEST\nconsole.log("hello")
```

## ä¸‹ä¸€æ­¥

- [Hooks](./hooks.md) - æ„å»ºç”Ÿå‘½å‘¨æœŸé’©å­
- [æ€§èƒ½ä¼˜åŒ–](./performance.md) - ä¼˜åŒ–æ„å»ºæ€§èƒ½
- [é…ç½®](./configuration.md) - è¯¦ç»†é…ç½®é€‰é¡¹
- [API æ–‡æ¡£](../api/) - ç¨‹åºåŒ– API ä½¿ç”¨
